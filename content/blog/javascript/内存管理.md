---
title: 内存管理
date: 2019-03-05 10:03:31
category: javascript
---


像`C`语言这样的底层语言一般都有底层的内存管理接口，比如 `malloc()`和 `free()` 。
另一方面，`JavaScript`创建变量（对象，字符串等）时分配内存，并且在不再使用它们时“自动”释放。 
后一个过程称为垃圾回收。这个“自动”是混乱的根源，并让 `JavaScript`（和其他高级语言）开发者感觉他们可以不关心内存管理。 这是错误的。

## 内存生命周期

不管什么程序语言，内存生命周期基本是一致的：  

  1. 分配你所需要的内存
  2. 使用分配到的内存（读、写）
  3. 不需要时将其释放\归还

所有语言第二部分都是明确的。
第一和第三部分在底层语言中是明确的，
但在像`JavaScript`这些高级语言中，大部分都是隐含的。


### JavaScript 的内存分配

为了不让程序员费心分配内存，`JavaScript` 在定义变量时就完成了内存分配。

```JS
var n = 123; // 给数值变量分配内存
var s = "azerty"; // 给字符串分配内存

var o = {
  a: 1,
  b: null
}; // 给对象及其包含的值分配内存

// 给数组及其包含的值分配内存（就像对象一样）
var a = [1, null, "abra"]; 

function f(a){
  return a + 2;
} // 给函数（可调用的对象）分配内存

// 函数表达式也能分配一个对象
someElement.addEventListener('click', function(){
  someElement.style.backgroundColor = 'blue';
}, false);
```


#### 通过函数调用分配内存

有些函数调用结果是分配对象内存：

```js
var d = new Date(); // 分配一个 Date 对象
var e = document.createElement('div'); // 分配一个 DOM 元素
```

有些方法分配新变量或者新对象

```js
var zanjs = 'zanjs';
var s2 = zanjs.substr(0,2) // s2 是一个新的字符串
// 因为字符串不是变量
// Javascript 可能决定不分配内存，
// 只是存储了 [0-2] 的范围

var a = ['ot', 'ol', 'ul'];
var a2 = ['div', 'ul'];
var a3 = a.concat(a2)
// 新数组有四个元素，是 a 连接 a2 的结果
```


#### 使用值

使用之的过程实际上是对分配内存进行读取和写入的操作。
读取与写入可能是 写入一个变量或者一个对象的属性值，甚至传递函数的参数。

### 当内存不在需要使用时释放

大多数内存管理的问题都在这个阶段。在这里最艰难的任务是找到“所分配的内存确实已经不在需要了”。
它往往要求开发人员来确定在程序中哪一块不在内存不在需要并且释放它。

高级语言解释器嵌入了“垃圾回收器”， 它的主要工作是跟踪内存的分配和使用，
以便当分配的内存不在使用时，自动释放它，这只能是一个近似的过程，因为要知道释放仍然需要某块内存


## 垃圾回收


如上文所述自动寻找是否一些内存“不再需要”的问题是无法判定的。因此，垃圾回收实现只能有限制的解决一般问题。

垃圾回收算法主要依赖于引用的概念。在内存管理的环境中，一个对象如果有访问另一个对象的权限（隐式或者显示），
叫做一个对象引用另一个对象。
例如，一个 `Javascript` 对象具有对它原型的引用（隐式引用） 和对它属性的引用（显示引用）

在这里，“对象”的概念不仅特指 `JavaScript` 对象，还包括函数作用域（或者全局词法作用域）。